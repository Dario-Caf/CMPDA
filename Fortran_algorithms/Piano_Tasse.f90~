Program Piano_Tasse
  
  Use LibraryDer
  
  Implicit None
  Real(rk), Parameter::a=0._rk,b=64000._rk
  Real(rk), Allocatable:: x(:), y(:),dy(:)
  Real(rk)::x0(0:10),y0(0:10),y0E(0:10)
  Procedure(fun_R_R), pointer::fun
  Real(rk) ::integr_s
  Integer(rk) :: i,o=1,m=2,e=10,N=100

  x0(0:10)=[0,4725,7350,12600,18900,26250,33600,40000,50400,58800,64000]
  y0(0:10)=[0,2619,1865,4283,4217,3153,1785,820,635,223,336]
  y0E(0:10)=[0,884,636,1274,825,74,8,3,3,1,0]
  
  !Generiamo la fun P senza esonerati e la interpoliamo
  open (1,file='P.dat')
  y0=y0-y0E
  Do i=1,10
     y0(i)=y0(i)+y0(i-1) 
  end do
  Allocate(x(0:N),y(0:N))
  Forall (i=0: N) x(i)=a+i*(b-a)/N
  Do i=0,N
     Call interp(x0,y0,x(i),y(i),'aitken')
     if (y(i)<y(i-1)) y(i)=y(i-1)
     write(1,'(2(x,E19.12))') x(i),y(i)
  End do
  close(1)

  !Generiamo la funzione lambda da P
  open (2,file='l.dat')
  Allocate (dy(0:N))
  Do i=0,N
     If (Der(x,y,i,o,m,e,dy(i))/=0) Stop 'Error'
     if (y(i)<y(i-1)) y(i)=y(i-1)
     write(2,'(2(x,E19.12))') x(i),dy(i)
  End do
  close (2)

  !Verifica funzionalitÃ  della funzione f
  fun=>f
  open (3,file='f.dat')
  Do i=0,N
     write(3,'(4(x,E19.12))') x(i),fun(x(i)),T(x(i),x0),abs(T(x(i),x0)-fun(x(i)))
  End do
  close (3)
  
  !Calcoliamo il valore dell'integrale

  !fun(i)=f(x(i))*dy(i)
  !if(integrate(x,y,integr_s,'simpson')/=0) stop
  !print *,integr_s

  Deallocate (x,y,dy)

Contains

  Function f(h)
    Implicit None
    Real(rk), Intent(in) :: h
    Real(rk) :: a=2000._rk,b=2.0312E-5_rk,c=145.32_rk,f

    if (h<=23902._rk) then
       f=h*0.025_rk+317._rk
    else
       f=a*(1._rk-e**(-b*h)) + c
    end if
    
  End Function f

  Function T(h,x0)
    Implicit None
    Real(rk), Intent(in) :: h,x0(0:10)
    Real(rk) :: T
 
    if (h<=x(0)) then
       T=371._rk
    else if (h<=x(1)) then
       T=457._rk
    else if (h<=x(2)) then
       T=556._rk
    else if (h<=x(3)) then
       T=607._rk
    else if (h<=x(4)) then
       T=843._rk
    else if (h<=x(5)) then
       T=1075._rk
    else if (h<=x(6)) then
       T=1300._rk
    else if(h<=x(7)) then
       T=1358._rk
    else if (h<=x(8)) then
       T=1426._rk
    else if (h>=x(8)) then
       T=1484._rk
    end if

  End Function T

End Program Piano_Tasse
